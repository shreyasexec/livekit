services:
  redis:
    image: redis:7-alpine
    network_mode: host
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    network_mode: host
    environment:
      - LIVEKIT_KEYS=${LIVEKIT_API_KEY}:${LIVEKIT_API_SECRET}
    volumes:
      - ./configs/livekit.yaml:/livekit.yaml
    command: ["--config", "/livekit.yaml", "--node-ip", "${LIVEKIT_NODE_IP}"]
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  livekit-sip:
    image: livekit/sip:latest
    network_mode: host
    volumes:
      - ./configs/sip.yaml:/sip.yaml
    environment:
      - SIP_CONFIG_FILE=/sip.yaml
    command: ["--config", "/sip.yaml"]
    restart: unless-stopped
    profiles:
      - sip

  whisperlive:
    image: ghcr.io/collabora/whisperlive-cpu:latest
    network_mode: host
    environment:
      - OMP_NUM_THREADS=4
    command:
      - python3
      - run_server.py
      - --port
      - "9090"
      - --backend
      - faster_whisper
      - --no_single_model
      - --max_clients
      - "10"
      - --max_connection_time
      - "600"
    healthcheck:
      test:
        - CMD-SHELL
        - python3 -c "import socket; s = socket.socket(); s.settimeout(2); s.connect(('localhost', 9090)); s.close()"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 45s
    restart: unless-stopped

  piper-tts:
    build:
      context: ./tts-service
      dockerfile: Dockerfile
    network_mode: host
    volumes:
      - piper_voices:/app/voices
    environment:
      - PIPER_VOICE=en_US-lessac-medium
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5500/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  agent-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    network_mode: host
    environment:
      - LIVEKIT_URL=ws://127.0.0.1:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - REDIS_URL=redis://127.0.0.1:6379
      - OLLAMA_URL=${OLLAMA_URL}
      - WHISPERLIVE_HOST=127.0.0.1
      - WHISPERLIVE_PORT=9090
      - PIPER_URL=http://127.0.0.1:5500
    depends_on:
      redis:
        condition: service_healthy
      whisperlive:
        condition: service_healthy
      piper-tts:
        condition: service_healthy
    command: ["python", "-m", "agent.worker", "dev"]
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    network_mode: host
    environment:
      - LIVEKIT_URL=http://127.0.0.1:7880
      - LIVEKIT_PUBLIC_URL=wss://${LIVEKIT_NODE_IP}:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - REDIS_URL=redis://127.0.0.1:6379
    depends_on:
      redis:
        condition: service_healthy
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c ''import httpx; httpx.get("http://localhost:8000/health", timeout=2).raise_for_status()'' || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    network_mode: host
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_LIVEKIT_URL=${VITE_LIVEKIT_URL}
        - VITE_API_URL=${VITE_API_URL}
    network_mode: host
    environment:
      - VITE_LIVEKIT_URL=${VITE_LIVEKIT_URL}
      - VITE_API_URL=${VITE_API_URL}
    restart: unless-stopped

volumes:
  redis_data:
  piper_voices:
