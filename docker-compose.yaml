services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  livekit:
    image: livekit/livekit-server:latest
    ports:
      - "50000-50100:50000-50100/udp"
      - "3478:3478"
    expose:
      - "7880"
      - "7881"
    volumes:
      - ./configs/livekit.yaml:/livekit.yaml
    command: ["--config", "/livekit.yaml"]
    environment:
      - LIVEKIT_RTC_NODE_IP=${LIVEKIT_NODE_IP}
      - LIVEKIT_RTC_USE_EXTERNAL_IP=false
      - LIVEKIT_TURN_ENABLED=true
      - LIVEKIT_TURN_DOMAIN=${LIVEKIT_TURN_DOMAIN}
      - LIVEKIT_TURN_SECRET=${LIVEKIT_TURN_SECRET}
      - LIVEKIT_TURN_UDP_PORT=3478
      - LIVEKIT_TURN_TLS_PORT=0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:7880 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  livekit-sip:
    image: livekit/sip:latest
    network_mode: host
    volumes:
      - ./configs/sip.yaml:/sip.yaml
    environment:
      - SIP_CONFIG_FILE=/sip.yaml
    command: ["--config", "/sip.yaml"]
    restart: unless-stopped
    profiles:
      - sip

    # Removed profiles to auto-start with docker compose up

  # WhisperLiveKit STT Service - Using --pcm-input for raw PCM audio from LiveKit
  # See: https://github.com/QuentinFuxa/WhisperLiveKit
  whisperlivekit:
    build:
      context: ./whisperlivekit
      dockerfile: Dockerfile
    ports:
      - "8765:8765"
    volumes:
      - whisper_cache:/root/.cache/huggingface  # Persist Whisper model cache
    environment:
      - OMP_NUM_THREADS=4
      - HF_HOME=/root/.cache/huggingface
    command:
      - wlk
      - --host
      - "0.0.0.0"
      - --port
      - "8765"
      - --model
      - "small"
      - --language
      - "en"
      - --pcm-input
      # Latency optimization settings - OPTIMIZED for low latency
      - --min-chunk-size
      - "0.2"  # Reduced from 0.5s for faster processing
      # Use faster local agreement backend for lower latency
      - --backend-policy
      - "localagreement"
      # Faster buffer trimming - reduced for quicker finalization
      - --buffer_trimming
      - "segment"
      - --buffer_trimming_sec
      - "2"  # Reduced from 5s for faster segment completion
      # DISABLE WhisperLiveKit VAD - LiveKit's Silero VAD handles turn detection
      # Having two VADs adds latency and can cause conflicts
      - --no-vad
    networks:
      - livekit-network
    healthcheck:
      test:
        - CMD-SHELL
        - >
          python3 -c "import socket; s=socket.socket(); s.settimeout(2); s.connect(('localhost',8765)); s.close()"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s
    restart: unless-stopped

  # Piper TTS Service
  piper-tts:
    build:
      context: ./tts-service
      dockerfile: Dockerfile
    ports:
      - "5500:5500"
    volumes:
      - piper_voices:/app/voices
    environment:
      - PIPER_VOICE=en_US-lessac-medium
    networks:
      - livekit-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5500/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # AI Agent Worker
  agent-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend/agent:/app/agent:ro  # Live code sync for development
    environment:
      - LIVEKIT_URL=http://livekit:7880
      - LIVEKIT_PUBLIC_URL=https://192.168.20.224:7880
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - REDIS_URL=redis://redis:6379
      - OLLAMA_URL=${OLLAMA_URL:-http://192.168.1.120:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.1:8b}
      # WhisperLiveKit for STT - External GPU Server (https://192.168.1.120:8765)
      - WHISPERLIVEKIT_HOST=192.168.1.120
      - WHISPERLIVEKIT_PORT=8765
      - WHISPERLIVEKIT_USE_SSL=true
      # Piper TTS URL for livekit-plugins-piper-tts
      - PIPER_TTS_URL=http://piper-tts:5500
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
      # whisperlivekit removed - using external GPU server at 192.168.1.120:8765
      piper-tts:
        condition: service_healthy
    command: ["python", "-m", "agent.worker", "dev"]
    networks:
      - livekit-network
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
    ports:
      - "8000:8000"
    environment:
      - LIVEKIT_URL=http://livekit:7880
      # Use port 3000 so WebSocket goes through Vite proxy (avoids SSL cert issues)
      - LIVEKIT_PUBLIC_URL=https://192.168.20.224:3000
      - LIVEKIT_API_KEY=${LIVEKIT_API_KEY}
      - LIVEKIT_API_SECRET=${LIVEKIT_API_SECRET}
      - REDIS_URL=redis://redis:6379
    depends_on:
      livekit:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: uvicorn main:app --host 0.0.0.0 --port 8000
    networks:
      - livekit-network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python -c ''import httpx; httpx.get("http://localhost:8000/health", timeout=2).raise_for_status()'' || exit 1',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # NGINX SSL Proxy
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    ports:
      - "443:443"
      - "7880:7880"
    depends_on:
      - livekit
      - backend
    networks:
      - livekit-network
    restart: unless-stopped

  # React Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      # Use same origin WebSocket (goes through Vite proxy to livekit:7880)
      - VITE_LIVEKIT_URL=wss://192.168.20.224:3000
      # Empty VITE_API_URL means relative paths, goes through Vite proxy to backend
      - VITE_API_URL=
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - livekit-network
    restart: unless-stopped

networks:
  livekit-network:
    driver: bridge

volumes:
  redis_data:
  piper_voices:
  whisper_cache:
